---
title: "Final Project Report"
author: "Kyle Bistrain, Dechen (Abby) Drongpa, Andrew Kerr, Liam Quach"
format: 
  html:
    toc: true
    number-sections: true
    code-fold: true
    css: styles.css
editor: visual
embed-resources: true
---

```{r}
#| label: library & data set up
#| include: false
#| message: false
#| warning: false

library(tidyverse)
library(here)
library(survival)
library(survminer)

tele <- read_csv(here("data", "Telco-Customer-Churn-Clean.csv"))
```

```{r}
#| label: data cleaning
#| include: false

# Convert character columns to factors
# Convert Churn (censoring variable) to 0 if right censored, otherwise 1
tele <- tele %>%
  mutate(
    across(where(~length(unique(.)) < 4), ~ as.factor(.)),
    Churn = case_when(
      Churn == "Yes" ~ 1,
      Churn == "No" ~ 0,
      TRUE ~ NA
      )
    ) 

# Check missing data
#
#   All 11 subjects are missing TotalCharges and have Churn = 0 and tenure = 0, 
#   so I am guessing that they are brand new customers. THus, will impute 
#   missing  values with 0.
#
tele %>%
  filter(if_any(everything(), is.na))

tele <- tele %>%
  mutate(TotalCharges = replace_na(TotalCharges, 0))

# write_csv(tele, here("data", "Telco-Customer-Churn-Clean.csv"))
```

```{r}
#| label: data exploration
#| include:  false

tele %>%
  ggplot(aes(x = tenure)) +
  geom_histogram(bins = 40, fill = "cornflowerblue", color = "black")
  

tele %>%
  filter(Churn == 0) %>%
  ggplot(aes(x = tenure)) +
  geom_histogram(bins = 40, fill = "cornflowerblue", color = "black")

tele %>%
  filter(Churn == 1) %>%
  ggplot(aes(x = tenure)) +
  geom_histogram(bins = 40, fill = "cornflowerblue", color = "black")
```

# Introduction

\[Look at README and put formatted info here\]

# Main Report

## Parametric Survival Analysis

Based on the probability plots in *Figure 1*, none of the four distributions fit this data well since the points do not fall close to the diagonal line for the lower half of the values. Therefore, we will rely on the Anderson Darling test statistic to determine the best fit. Although all four AD test statistics are close, the one for the Weibull distribution is the lowest (AD = 16986.795) and thus this distribution is the best fit.

![Figure 1. Probability Plots for Customer Churn Time Data by Distribution: Weibull (top left), Exponential (top right), Lognormal (bottom left), Logistic (bottom right)](images/parametric_analysis_plots.png){fig-align="center"}

From the survival curve in *Figure 2*, we notice a steep decrease in survival probability for individuals who have been with the company for fewer months, then a more gradual decrease after the individual has been with the company for roughly 200 months (approx. 16.67 years). The hazard curve displays a high risk of the customer discontinuing use of the company's services within the first few months, then a steep decrease in risk afterwords.

The mean survival time across all customers is 303.747 months while the median survival time is 124.766 months.

![Figure 2. Survival Plot (left) and Hazard Plot (right) for all individuals under the Weibull Distribution](images/parametric_analysis_plots_2.png){fig-align="center"}

We have decided to examine the survival and hazard curves of the following groups: the customers gender (Male. Female), whether the customer has multiple phone lines in service (Yes, No, No phone service), and the customers payment method (Electronic check, Mailed check, Bank transfer, Credit card).

### Gender

Based on the survival curves in *Figure 3*, the survival probability for female customers is slightly greater than that of male customers for any time $t$. However, hazard curves display the risk of male and female customers discontinuing use of the company's services is roughly the same for any time $t$.

The mean survival times by customer gender is 297.221 months (male) and 310.109 months (female) while the median survival times are 125.489 months (male) and 123.929 months (female).

From these observations, we can conclude that female customers tend to continue using the company's services longer than male customers.

![Figure 3. Survival Plot (left) and Hazard Plot (right) by Gender under the Weibull Distribution](images/parametric_analysis_plots_gender.png){fig-align="center"}

### Multiple Phone Lines

Based on the survival curves in *Figure 4*, the survival probability for customers without phone service is greater than that for customers with phone service across all time $t$. Additionally, the survival probability for customers with one line is greater than that for customers with multiple lines for all times $t$. Meanwhile the hazard curves mirror this conclusion, since customers with multiple phone lines have a greater risk of discontinuing use of the company's services than customers with one or no phone lines for all time $t$.

The mean survival times by amount of phone lines is 387.146 months (One Line), 194.881 months (Multiple Lines) and 431.113 months (No Lines) while the median survival times are 118.954 months (One Line), 115.632 months (Multiple Lines) and 151.271 months (No Lines).

In other words, the fewer the amount of phone lines the customer is paying the company for, the longer the customers tends to use the company's services.

![Figure 4. Survival Plot (left) and Hazard Plot (right) by Multiple Phone Lines under the Weibull Distribution](images/parametric_analysis_plots_multiplelines.png){fig-align="center"}

### Payment Method

Based on the survival curves in *Figure 5*, the survival probability for customers who pay through mailed check is greater than other methods after roughly 500 months. On the other hand customers that pay through electronic check have the lowest survival probability of the methods across all time $t$, with customers who pay through bank transfer or credit card (both automatic methods) having the greatest survival probability prior to 500 months, both having roughly the same probability. The hazard curves show that customers who pay through electronic check have the greatest risk of discontinuing use of the company's services across all time $t$, with the other payment methods being roughly equivalent.

The mean survival times by payment method is 399.551 months (Bank Transfer), 375.861 months (Credit Card), 85.7733 months (Electronic Check) and 778.702 months (Mailed Check) while the median survival times are 233.482 months (Bank Transfer), 234.105 months (Credit Card), 40.0773 months (Electronic Check) and 200.804 months (Mailed Check).

These curves show us that customers who pay through electronic check tend to stay with the company the shortest amount of time, while customers who pay through mailed check the longest.

![Figure 5. Survival Plot (left) and Hazard Plot (right) by Payment Method under the Weibull Distribution](images/parametric_analysis_plots_paymentmethod.png){fig-align="center"}

## Non-parametric Survival Analysis

In this section, we employ non-parametric methods to analyze customer churn patterns, complementing our previous parametric analysis using the Weibull distribution. Non-parametric approaches have the advantage of making no assumptions about the underlying distribution of survival times, providing potentially more accurate insights into customer retention patterns.

### Overall Survival Experience

```{r}
km_fit_all <- survfit(Surv(tenure, Churn) ~ 1, data = tele)

ggsurvplot(km_fit_all, 
           data = tele,
           xlab = "Time", 
           ylab = "Survival Probability",
           title = "Kaplan-Meier Curve - Overall")
```

Our non-parametric analysis reveals that the median survival time (time at which 50% of customers have churned) across all customers is 44 months, considerably shorter than the 124.766 months estimated by the Weibull model. This substantial difference suggests that the parametric approach may be overestimating customer retention times.

The Kaplan-Meier survival curve shows a steep decrease in survival probability during the first few months of service, indicating that new customers are at high risk of churning early in their relationship with the company.

### Survival by Gender

```{r}
km_fit_gender <- survfit(Surv(tenure, Churn) ~ gender, data = tele)

ggsurvplot(km_fit_gender, 
           data = tele,
           pval = TRUE,
           title = "Kaplan-Meier Curves by Payment Method")
```

```{r}
#| include: false

# the log-rank test
survdiff(Surv(tenure, Churn) ~ gender, data = tele, rho = 0)

print(km_fit_gender, print.rmean = TRUE)
```

When analyzing customer churn by gender using the Kaplan-Meier method, we found minimal differences between male and female customers:

| Gender | Median Survival (months) | Mean Survival (months) |
|--------|--------------------------|------------------------|
| Male   | 44                       | 40.9                   |
| Female | 45                       | 41.2                   |

The log-rank test comparing male and female survival curves yields a p-value of 0.8. This indicates no statistically significant difference in survival patterns between genders, suggesting that gender has virtually no impact on customer retention rates.

This non-parametric finding differs from our parametric analysis, which suggested female customers having slightly better retention than male customers. The Weibull model estimated mean survival times of 297.221 months for males and 310.109 months for females, implying a gender effect that is not supported by our non-parametric approach. This discrepancy highlights how parametric assumptions may sometimes lead to conclusions that aren't substantiated when fewer distributional assumptions are made.

### Survival by Multiple Phone Lines

```{r}
km_fit_lines <- survfit(Surv(tenure, Churn) ~ MultipleLines, data = tele)

ggsurvplot(km_fit_lines, 
           data = tele,
           pval = TRUE,
           title = "Kaplan-Meier Curves by Multiple Phone Lines")
```

```{r}
#| include: false
### log-rank test
survdiff(Surv(tenure, Churn) ~ MultipleLines, data = tele, rho = 0)
print(km_fit_lines, print.rmean = TRUE)
```

The Kaplan-Meier analysis by phone service configuration revealed meaningful differences in customer retention patterns:

| Phone Service    | Median Survival (months) | Mean Survival (months) |
|------------------|--------------------------|------------------------|
| No phone service | 42                       | 39.9                   |
| Single line      | 27                       | 31.5                   |
| Multiple lines   | 58                       | 51.3                   |

The log-rank test comparing these groups yielded a highly significant p-value (p \< 0.00001), confirming substantial differences in survival patterns across these customer segments.

Interestingly, these non-parametric results contradict our parametric findings. In the Weibull analysis, customers with fewer phone lines showed better retention, with mean survival times of 431.113 months (no phone service), 387.146 months (one line), and 194.881 months (multiple lines). In contrast, our non-parametric analysis suggests that customers with multiple lines have better retention than those with a single line.

### Survival by Payment Method

```{r}
km_fit_payment <- survfit(Surv(tenure, Churn) ~ PaymentMethod, data = tele)

ggsurvplot(km_fit_payment, 
           data = tele,
           pval = TRUE,
           title = "Kaplan-Meier Curves by Payment Method")
```

```{r}
#| include: false
survdiff(Surv(tenure, Churn) ~ PaymentMethod, data = tele, rho = 0)

print(km_fit_payment, print.rmean = TRUE)
```

Our non-parametric analysis by payment method revealed substantial differences in customer retention:

| Payment Method   | Median Survival (months) | Mean Survival (months) |
|------------------|--------------------------|------------------------|
| Bank transfer    | 54                       | 48.9                   |
| Credit card      | 53                       | 47.9                   |
| Electronic check | 42                       | 39.7                   |
| Mailed check     | 22                       | 27.0                   |

The log-rank test comparing these payment methods yielded a p-value \< 0.00001, indicating highly significant differences in survival patterns across these customer segments.

Our non-parametric findings partially align with the parametric results in identifying electronic check as a payment method associated with shorter customer tenure. However, they contradict the parametric finding that mailed check customers have the longest retention. In our non-parametric analysis, automatic payment methods (bank transfer and credit card) show the best retention, while mailed check customers have the poorest retention.

### Comparison with Parametric Analysis

To better understand the differences between our non-parametric and parametric approaches, we directly compared the survival time estimates produced by both methods:

| Customer Group | Non-parametric Median (months) | Parametric Median (months) | Difference (%) |
|-----------------|--------------------|------------------|-----------------|
| Overall | 44.0 | 124.8 | +183.6% |
| Male | 44.0 | 125.5 | +185.2% |
| Female | 45.0 | 123.9 | +175.3% |
| No phone service | 42.0 | 151.3 | +260.2% |
| Single line | 27.0 | 119.0 | +340.7% |
| Multiple lines | 58.0 | 115.6 | +99.3% |
| Bank transfer | 54.0 | 233.5 | +332.4% |
| Credit card | 53.0 | 234.1 | +341.7% |
| Electronic check | 42.0 | 40.1 | -4.5% |
| Mailed check | 22.0 | 200.8 | +813.6% |

Several key differences emerged between our parametric and non-parametric analyses:

1.  **Overall survival times**: The non-parametric approach yielded much shorter median survival times compared to the Weibull model, with the parametric approach overestimating median retention by 184% on average. Only for electronic check customers were the estimates similar between methods.

2.  **Multiple phone lines impact**: The parametric analysis suggested that fewer phone lines correlate with better retention, while the non-parametric analysis showed customers with multiple lines having better retention than those with a single line. This contradiction highlights the sensitivity of survival estimates to modeling assumptions.

3.  **Payment method influence**: Both approaches identified electronic check as associated with poorer retention, but they differed on which payment method correlates with the best retention. The non-parametric analysis showed automatic payment methods as superior, while the parametric approach suggested mailed checks lead to the longest customer relationships.

4.  **Magnitude of differences**: The parametric approach generally estimated much larger differences between groups than the non-parametric approach. The most extreme discrepancy was for mailed check customers, where the Weibull model estimate was over 800% higher than the Kaplan-Meier estimate.

## Regression Analysis

# Conclusion

# Appendix
